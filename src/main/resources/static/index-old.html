<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BEAM">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>âš¡ BEAM - Messages at the speed of light</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    
    <!-- iOS PWA ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9InVybCgjZ3JhZGllbnQwKSIvPgo8cGF0aCBkPSJNOTAgNDhDNzQuMzI3IDQ4IDYyIDYwLjMyNyA2MiA3NlM3NC4zMjcgMTA0IDkwIDEwNFMxMTggOTEuNjczIDExOCA3NlMxMDUuNjczIDQ4IDkwIDQ4Wk0xMDIgNzlINzhDNzUuMjM5IDc5IDczIDc2Ljc2MSA3MyA3NFM3NS4yMzkgNjkgNzggNjlIMTAyQzEwNC43NjEgNjkgMTA3IDcxLjIzOSAxMDcgNzRTMTA0Ljc2MSA3OSAxMDIgNzlaIiBmaWxsPSJ3aGl0ZSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDAiIHgxPSIwIiB5MT0iMCIgeDI9IjE4MCIgeTI9IjE4MCIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjMDA3OEQ0Ii8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzYyNjRBNyIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=">
    
    <style>
        /* CSS ë³€ìˆ˜ ì •ì˜ */
        :root {
            /* ê¸°ë³¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
            --primary: #10B981;
            --primary-light: #40a9ff;
            --primary-dark: #005a9e;
            --secondary: #6264a7;
            --accent: #f093fb;
            --success: #52c41a;
            --warning: #faad14;
            --error: #ff4d4f;
            --info: #1890ff;
            
            /* ë³´ì•ˆ ëª¨ë“œ ìƒ‰ìƒ */
            --secret: #722ed1;
            --secret-light: #b37feb;
            --volatile: #f5222d;
            --volatile-light: #ff7875;
            
            /* ë°°ê²½ ìƒ‰ìƒ */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --bg-chat: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --bg-overlay: rgba(0, 0, 0, 0.5);
            
            /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-tertiary: #8c8c8c;
            --text-disabled: #bfbfbf;
            --text-inverse: #ffffff;
            
            /* ê²½ê³„ì„  ìƒ‰ìƒ */
            --border-light: #f0f0f0;
            --border-base: #d9d9d9;
            --border-dark: #434343;
            
            /* ê·¸ë¦¼ì */
            --shadow-1: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-2: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-3: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-4: 0 16px 48px rgba(0, 0, 0, 0.16);
            
            /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 24px;
            --radius-full: 50%;
            
            /* ì• ë‹ˆë©”ì´ì…˜ */
            --motion-ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --motion-ease-in-out: cubic-bezier(0.645, 0.045, 0.355, 1);
            --motion-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* ìŠ¤í˜ì´ì‹± */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Z-Index */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* ë‹¤í¬ í…Œë§ˆ */
        [data-theme="dark"] {
            --bg-primary: #141414;
            --bg-secondary: #1f1f1f;
            --bg-tertiary: #262626;
            --bg-chat: #1a1a1a;
            --bg-glass: rgba(20, 20, 20, 0.8);
            
            --text-primary: #ffffff;
            --text-secondary: #d9d9d9;
            --text-tertiary: #8c8c8c;
            --text-disabled: #434343;
            
            --border-light: #303030;
            --border-base: #434343;
            --border-dark: #d9d9d9;
            
            --shadow-1: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-2: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-3: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-4: 0 16px 48px rgba(0, 0, 0, 0.6);
        }

        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë¦¬ì…‹ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--bg-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-base);
            border-radius: 3px;
            transition: background 0.2s var(--motion-ease-out);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ */
        .app {
            display: flex;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            overflow: hidden;
        }

        /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ë°°ê²½ */
        .glass-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 120, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 320px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            transition: transform 0.3s var(--motion-ease-out);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0;
            pointer-events: none;
        }

        /* ì‚¬ì´ë“œë°” í—¤ë” */
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            position: relative;
            z-index: 2;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s var(--motion-ease-out);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-weight: 600;
            font-size: 18px;
            position: relative;
            box-shadow: var(--shadow-2);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--success);
            border: 2px solid var(--bg-primary);
            border-radius: var(--radius-full);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .user-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-status {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: var(--radius-full);
            background: var(--success);
        }

        /* ë³´ì•ˆ ëª¨ë“œ í† ê¸€ */
        .security-modes {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-xs);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            position: relative;
        }

        .security-mode {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-base);
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
            position: relative;
            z-index: 1;
        }

        .security-mode.active {
            color: var(--text-inverse);
            background: var(--primary);
            box-shadow: var(--shadow-1);
            transform: scale(1.02);
        }

        .security-mode.secret.active {
            background: var(--secret);
        }

        .security-mode.volatile.active {
            background: var(--volatile);
        }

        /* ì±„íŒ…ë°© ëª©ë¡ */
        .rooms-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .rooms-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
        }

        .create-room-button {
            width: 100%;
            padding: var(--space-md);
            border: 1px dashed var(--border-base);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
            backdrop-filter: blur(10px);
        }

        .create-room-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .rooms-list {
            height: 100%;
            overflow-y: auto;
            padding: var(--space-md);
            scroll-behavior: smooth;
        }

        .room-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .room-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .room-item.active {
            background: var(--primary);
            color: var(--text-inverse);
            box-shadow: var(--shadow-2);
            transform: translateX(8px);
        }

        .room-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
            box-shadow: var(--shadow-1);
        }

        .room-icon.normal {
            background: linear-gradient(135deg, #52c41a, #73d13d);
        }

        .room-icon.secret {
            background: linear-gradient(135deg, var(--secret), var(--secret-light));
        }

        .room-icon.volatile {
            background: linear-gradient(135deg, var(--volatile), var(--volatile-light));
        }

        .room-details h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .room-meta {
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
            position: relative;
            z-index: 1;
        }

        /* ì±„íŒ… í—¤ë” */
        .chat-header {
            padding: var(--space-lg) var(--space-xl);
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: var(--shadow-1);
        }

        .chat-details h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-security-badge {
            padding: 4px 8px;
            border-radius: var(--radius-base);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-security-badge.normal {
            background: rgba(82, 196, 26, 0.1);
            color: var(--success);
        }

        .chat-security-badge.secret {
            background: rgba(114, 46, 209, 0.1);
            color: var(--secret);
        }

        .chat-security-badge.volatile {
            background: rgba(245, 34, 45, 0.1);
            color: var(--volatile);
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .room-owner-info {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 12px;
        }

        .owner-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b6914;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .room-password {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .chat-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .action-button {
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-base);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
            backdrop-filter: blur(10px);
        }

        .action-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            scroll-behavior: smooth;
        }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            display: flex;
            gap: var(--space-md);
            max-width: 80%;
            animation: messageSlideIn 0.4s var(--motion-ease-out);
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.system {
            align-self: center;
            max-width: 60%;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: var(--shadow-1);
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 12px;
        }

        .message-sender {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .message-time {
            color: var(--text-tertiary);
            font-size: 11px;
        }

        .message-security-badge {
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .message-security-badge.secret {
            background: var(--secret);
            color: var(--text-inverse);
        }

        .message-security-badge.volatile {
            background: var(--volatile);
            color: var(--text-inverse);
        }

        .message-bubble {
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow-1);
            transition: all 0.3s var(--motion-ease-out);
        }

        .message:not(.own) .message-bubble {
            background: var(--bg-glass);
            border: 1px solid var(--border-light);
            border-top-left-radius: var(--radius-sm);
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--text-inverse);
            border-top-right-radius: var(--radius-sm);
            box-shadow: var(--shadow-2);
        }

        .message.system .message-bubble {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-tertiary);
            font-style: italic;
            text-align: center;
            border-radius: var(--radius-lg);
        }

        .message.secret .message-bubble {
            border-left: 3px solid var(--secret);
        }

        .message.volatile .message-bubble {
            border-left: 3px solid var(--volatile);
            position: relative;
        }

        .volatile-timer {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: var(--volatile);
            color: var(--text-inverse);
            border: 2px solid var(--bg-primary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            padding: var(--space-lg) var(--space-xl);
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            position: relative;
        }

        .volatile-controls {
            display: none;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            padding: var(--space-md);
            background: rgba(245, 34, 45, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(245, 34, 45, 0.2);
        }

        .volatile-controls.show {
            display: flex;
        }

        .volatile-timer-select {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-base);
            border-radius: var(--radius-base);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
        }

        .message-input-container {
            display: flex;
            gap: var(--space-md);
            align-items: flex-end;
            position: relative;
        }

        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-2xl);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
            resize: none;
            font-family: inherit;
            transition: all 0.3s var(--motion-ease-out);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            transform: scale(1.01);
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-button {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--text-inverse);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--motion-bounce);
            box-shadow: var(--shadow-2);
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-3);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: var(--text-disabled);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            animation: modalFadeIn 0.3s var(--motion-ease-out);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }

        .login-form {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: var(--space-2xl);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-4);
            width: 380px;
            max-width: 90vw;
            border: 1px solid var(--border-light);
            animation: modalSlideIn 0.4s var(--motion-bounce);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s var(--motion-ease-out);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            transform: scale(1.02);
        }

        .form-buttons {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }

        .form-button {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
            position: relative;
            overflow: hidden;
        }

        .form-button.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--text-inverse);
            box-shadow: var(--shadow-2);
        }

        .form-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-3);
        }

        .form-button.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-base);
        }

        .form-button.secondary:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        /* ì•Œë¦¼ */
        .notification {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            color: var(--text-inverse);
            font-weight: 500;
            z-index: var(--z-tooltip);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: notificationSlideIn 0.4s var(--motion-bounce);
            box-shadow: var(--shadow-3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success), #73d13d);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error), #ff7875);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info), #40a9ff);
        }

        /* ì‚¬ìš©ì ëª©ë¡ */
        .users-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-3);
            min-width: 200px;
            z-index: var(--z-dropdown);
            display: none;
            animation: dropdownSlideIn 0.3s var(--motion-ease-out);
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .users-dropdown.show {
            display: block;
        }

        .user-item {
            padding: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition: background 0.2s var(--motion-ease-out);
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--success);
            animation: pulse 2s infinite;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                bottom: 0;
                z-index: var(--z-fixed);
                box-shadow: var(--shadow-4);
            }

            .sidebar.open {
                transform: translateX(320px);
            }

            .chat-area {
                width: 100%;
            }

            .message {
                max-width: 85%;
            }

            .sidebar-header {
                padding: var(--space-md);
            }

            .chat-header {
                padding: var(--space-md) var(--space-lg);
            }

            .messages-container {
                padding: var(--space-md) var(--space-lg);
            }

            .input-area {
                padding: var(--space-md) var(--space-lg);
            }

            .login-form {
                padding: var(--space-xl);
                margin: var(--space-md);
            }
        }

        /* iOS ì•ˆì „ ì˜ì—­ ì§€ì› */
        @supports (padding: max(0px)) {
            .sidebar-header {
                padding-top: max(var(--space-lg), env(safe-area-inset-top));
            }

            .input-area {
                padding-bottom: max(var(--space-lg), env(safe-area-inset-bottom));
            }
        }

        /* ë‹¤í¬ ëª¨ë“œ í† ê¸€ ì• ë‹ˆë©”ì´ì…˜ */
        .theme-transition {
            transition: background-color 0.3s var(--motion-ease-out),
                        color 0.3s var(--motion-ease-out),
                        border-color 0.3s var(--motion-ease-out);
        }

        /* ì´ˆê¸° ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            animation: loadingFadeOut 0.5s var(--motion-ease-out) 1s forwards;
        }

        @keyframes loadingFadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ */
        .install-prompt {
            position: fixed;
            top: var(--space-lg);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-3);
            z-index: var(--z-modal);
            display: none;
            animation: notificationSlideIn 0.4s var(--motion-bounce);
        }

        .install-prompt.show {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .install-button {
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-base);
            background: var(--primary);
            color: var(--text-inverse);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--motion-ease-out);
        }

        .install-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* ì ‘ê·¼ì„± ê°œì„  */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ê³ ëŒ€ë¹„ ëª¨ë“œ ì§€ì› */
        @media (prefers-contrast: high) {
            :root {
                --border-light: #000000;
                --border-base: #000000;
                --shadow-1: 0 2px 8px rgba(0, 0, 0, 0.5);
                --shadow-2: 0 4px 12px rgba(0, 0, 0, 0.6);
                --shadow-3: 0 8px 24px rgba(0, 0, 0, 0.7);
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
    <div class="install-prompt" id="installPrompt">
        <span>ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ì—¬ ë” ë‚˜ì€ ê²½í—˜ì„ ì¦ê¸°ì„¸ìš”!</span>
        <button class="install-button" id="installButton">ì„¤ì¹˜</button>
        <button class="install-button" id="dismissInstall" style="background: var(--text-tertiary);">ë‚˜ì¤‘ì—</button>
    </div>

    <div class="app">
        <!-- ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ë°°ê²½ -->
        <div class="glass-bg"></div>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <header class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h3 id="userName">ì‚¬ìš©ì</h3>
                        <div class="user-status">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="statusText">ì—°ê²° ì¤‘...</span>
                        </div>
                    </div>
                </div>

                <div class="security-modes">
                    <button class="security-mode active" data-mode="normal">ì¼ë°˜</button>
                    <button class="security-mode secret" data-mode="secret">ğŸ” ë¹„ë°€</button>
                    <button class="security-mode volatile" data-mode="volatile">â° ì„ì‹œ</button>
                </div>
            </header>

            <div class="rooms-container">
                <div class="rooms-header">
                    <button class="create-room-button" id="createRoomButton">â• ë°© ë§Œë“¤ê¸°</button>
                </div>
                <div class="rooms-list" id="roomsList">
                    <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </aside>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <main class="chat-area">
            <header class="chat-header">
                <div class="chat-info">
                    <div class="chat-avatar normal" id="chatAvatar">ğŸ’¬</div>
                    <div class="chat-details">
                        <h2 id="chatTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                        <div class="chat-meta">
                            <div class="chat-security-badge normal" id="chatSecurityBadge">ì¼ë°˜ ëª¨ë“œ</div>
                            <div class="room-owner-info" id="roomOwnerInfo" style="display: none;">
                                <span class="owner-badge">ğŸ‘‘ ë°©ì¥</span>
                                <span class="room-password" id="roomPassword"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-actions">
                    <button class="action-button" id="usersButton">ğŸ‘¥ ì‚¬ìš©ì</button>
                    <button class="action-button" id="themeButton">ğŸŒ™ í…Œë§ˆ</button>
                    <button class="action-button" id="logoutButton">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                    <button class="action-button mobile-menu" id="mobileMenuButton">â˜°</button>
                </div>

                <div class="users-dropdown" id="usersDropdown">
                    <!-- ì‚¬ìš©ì ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div class="message system">
                    <div class="message-bubble">
                        ğŸš€ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”!
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="volatile-controls" id="volatileControls">
                    <span>â° ìë™ ì‚­ì œ:</span>
                    <select class="volatile-timer-select" id="volatileTimer">
                        <option value="10">10ì´ˆ í›„</option>
                        <option value="30" selected>30ì´ˆ í›„</option>
                        <option value="60">1ë¶„ í›„</option>
                        <option value="300">5ë¶„ í›„</option>
                    </select>
                </div>

                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="1"
                        maxlength="1000"
                    ></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        ğŸ“¤
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <div class="login-header">
                <h1 class="login-title">ğŸ” BEAM</h1>
                <p class="login-subtitle">ì•ˆì „í•˜ê³  ì•„ë¦„ë‹¤ìš´ ë©”ì‹ ì €ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
            </div>

            <!-- ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ í¼ (ê¸°ë³¸) -->
            <form id="guestForm">
                <div class="form-group">
                    <label class="form-label" for="nicknameInput">ë‹‰ë„¤ì„</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="nicknameInput" 
                        placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        maxlength="20"
                    >
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-tertiary);">
                        í¬íŠ¸í´ë¦¬ì˜¤ ì²´í—˜ìš© - ê³„ì • ìƒì„± ì—†ì´ ë°”ë¡œ ì±„íŒ…í•˜ì„¸ìš”!
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-button secondary" id="showLoginFormButton">
                        íšŒì› ë¡œê·¸ì¸
                    </button>
                    <button type="submit" class="form-button primary" id="guestLoginButton">
                        ì±„íŒ… ì‹œì‘
                    </button>
                </div>
            </form>

            <!-- íšŒì› ë¡œê·¸ì¸ í¼ (ìˆ¨ê¹€) -->
            <form id="loginForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label" for="usernameInput">ì‚¬ìš©ìëª…</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="usernameInput" 
                        placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="username"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="passwordInput">ë¹„ë°€ë²ˆí˜¸</label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="passwordInput" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="current-password"
                        minlength="4"
                    >
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-button secondary" id="backToGuestButton">
                        ë’¤ë¡œ
                    </button>
                    <button type="button" class="form-button secondary" id="showRegisterButton">
                        íšŒì›ê°€ì…
                    </button>
                    <button type="submit" class="form-button primary" id="loginButton">
                        ë¡œê·¸ì¸
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div class="login-modal" id="registerModal" style="display: none;">
        <div class="login-form">
            <div class="login-header">
                <h1 class="login-title">ğŸ‘¤ íšŒì›ê°€ì…</h1>
                <p class="login-subtitle">ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
            </div>

            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="regUsernameInput">ì‚¬ìš©ìëª… <span style="color: var(--error);">*</span></label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="regUsernameInput" 
                        placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="username"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="regEmailInput">ì´ë©”ì¼ (ì„ íƒ)</label>
                    <input 
                        type="email" 
                        class="form-input" 
                        id="regEmailInput" 
                        placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"
                        autocomplete="email"
                    >
                    <div id="emailFormatMessage" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="regPasswordInput">ë¹„ë°€ë²ˆí˜¸ <span style="color: var(--error);">*</span></label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="regPasswordInput" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="new-password"
                        minlength="4"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="regPasswordConfirmInput">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span style="color: var(--error);">*</span></label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="regPasswordConfirmInput" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="new-password"
                        minlength="4"
                    >
                    <div id="passwordMatchMessage" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-button secondary" id="backToLoginButton">
                        ë’¤ë¡œ
                    </button>
                    <button type="submit" class="form-button primary" id="registerSubmitButton">
                        ê°€ì…í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë°© ìƒì„± ëª¨ë‹¬ -->
    <div class="login-modal" id="createRoomModal" style="display: none;">
        <div class="login-form">
            <div class="login-header">
                <h1 class="login-title">ğŸ  ë°© ë§Œë“¤ê¸°</h1>
                <p class="login-subtitle">ìƒˆë¡œìš´ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”</p>
            </div>

            <form id="createRoomForm">
                <div class="form-group">
                    <label class="form-label" for="roomNameInput">ë°© ì´ë¦„ <span style="color: var(--error);">*</span></label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="roomNameInput" 
                        placeholder="ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        maxlength="50"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="roomTypeSelect">ë°© ìœ í˜• <span style="color: var(--error);">*</span></label>
                    <select class="form-input" id="roomTypeSelect" required>
                        <option value="NORMAL">ì¼ë°˜ë°©</option>
                        <option value="SECRET">ë¹„ë°€ë°© (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)</option>
                        <option value="VOLATILE">ì„ì‹œë°© (ë©”ì‹œì§€ ìë™ì‚­ì œ)</option>
                    </select>
                </div>

                <div class="form-group" id="passwordGroup" style="display: none;">
                    <label class="form-label" for="roomPasswordInput">ë°© ë¹„ë°€ë²ˆí˜¸ <span style="color: var(--error);">*</span></label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="roomPasswordInput" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        minlength="4"
                        maxlength="20"
                    >
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-tertiary);">
                        ë°©ì¥ë§Œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="roomDescInput">ë°© ì„¤ëª… (ì„ íƒ)</label>
                    <textarea 
                        class="form-input" 
                        id="roomDescInput" 
                        placeholder="ì±„íŒ…ë°©ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"
                        rows="2"
                        maxlength="100"
                    ></textarea>
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-button secondary" id="cancelCreateRoom">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="form-button primary" id="submitCreateRoom">
                        ë°© ë§Œë“¤ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¹„ë°€ë°© ì…ì¥ ëª¨ë‹¬ -->
    <div class="login-modal" id="joinSecretRoomModal" style="display: none;">
        <div class="login-form">
            <div class="login-header">
                <h1 class="login-title">ğŸ” ë¹„ë°€ë°© ì…ì¥</h1>
                <p class="login-subtitle" id="secretRoomName">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>

            <form id="joinSecretRoomForm">
                <div class="form-group">
                    <label class="form-label" for="secretRoomPasswordInput">ë¹„ë°€ë²ˆí˜¸</label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="secretRoomPasswordInput" 
                        placeholder="ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    >
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-button secondary" id="cancelJoinSecret">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="form-button primary" id="submitJoinSecret">
                        ì…ì¥í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class BEAMApp {
            constructor() {
                this.ws = null;
                this.currentUser = '';
                this.currentRoom = '';
                this.currentSecurityMode = 'NORMAL';
                this.userType = 'guest'; // ê¸°ë³¸ê°’: ê²ŒìŠ¤íŠ¸
                this.rooms = new Map();
                this.users = new Map();
                this.isDarkMode = false;
                this.deferredPrompt = null;
                this.pendingSecretRoomId = null;
                this.ownedRooms = new Set(); // ë‚´ê°€ ë§Œë“  ë°©ë“¤
                this.roomPasswords = new Map(); // ë‚´ê°€ ë§Œë“  ë¹„ë°€ë°©ì˜ ë¹„ë°€ë²ˆí˜¸ë“¤
                
                this.init();
            }

            async init() {
                this.setupPWA();
                this.bindEvents();
                this.setupThemeTransitions();
                this.showLoginModal();

                // ë¡œë”© í™”ë©´ ì œê±°
                setTimeout(() => {
                    const loading = document.getElementById('loadingOverlay');
                    if (loading) loading.remove();
                }, 1500);
            }

            /**
             * XSS ë°©ì–´: HTML ë¬¸ìì—´ì„ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
             * @param {string} str - ì´ìŠ¤ì¼€ì´í”„í•  ë¬¸ìì—´
             * @returns {string} - ì´ìŠ¤ì¼€ì´í”„ëœ ì•ˆì „í•œ ë¬¸ìì—´
             */
            escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            /**
             * ì…ë ¥ê°’ ê²€ì¦: ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ë° ìœ„í—˜í•œ íŒ¨í„´ ì œê±°
             * @param {string} input - ê²€ì¦í•  ì…ë ¥ê°’
             * @returns {string} - ê²€ì¦ëœ ì•ˆì „í•œ ë¬¸ìì—´
             */
            sanitizeInput(input) {
                if (!input) return '';

                // ê¸°ë³¸ trim
                let sanitized = input.trim();

                // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°
                sanitized = sanitized.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

                // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±° (on* attributes)
                sanitized = sanitized.replace(/on\w+\s*=\s*["'][^"']*["']/gi, '');

                // javascript: protocol ì œê±°
                sanitized = sanitized.replace(/javascript:/gi, '');

                return sanitized;
            }

            setupPWA() {
                // Service Worker ë“±ë¡
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('SW ë“±ë¡ ì„±ê³µ:', registration);
                        })
                        .catch(error => {
                            console.log('SW ë“±ë¡ ì‹¤íŒ¨:', error);
                        });
                }

                // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt();
                });

                // PWA ì„¤ì¹˜ ì™„ë£Œ
                window.addEventListener('appinstalled', () => {
                    console.log('PWA ì„¤ì¹˜ ì™„ë£Œ');
                    this.hideInstallPrompt();
                    this.showNotification('ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                });
            }

            setupThemeTransitions() {
                // í…Œë§ˆ ì „í™˜ ì‹œ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
                document.documentElement.classList.add('theme-transition');
            }

            bindEvents() {
                // ë¡œê·¸ì¸ ê´€ë ¨
                document.getElementById('guestForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.guestLogin();
                });
                document.getElementById('showLoginFormButton').addEventListener('click', () => this.showMemberLoginForm());
                document.getElementById('backToGuestButton').addEventListener('click', () => this.showGuestLoginForm());
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });
                document.getElementById('showRegisterButton').addEventListener('click', () => this.showRegisterModal());
                document.getElementById('registerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.register();
                });
                document.getElementById('backToLoginButton').addEventListener('click', () => this.showLoginModal());

                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì‹¤ì‹œê°„ ê²€ì¦
                document.getElementById('regPasswordInput').addEventListener('input', () => this.checkPasswordMatch());
                document.getElementById('regPasswordConfirmInput').addEventListener('input', () => this.checkPasswordMatch());

                // ì´ë©”ì¼ í˜•ì‹ ì‹¤ì‹œê°„ ê²€ì¦
                document.getElementById('regEmailInput').addEventListener('blur', () => this.checkEmailFormat());

                // ë©”ì‹œì§€ ì…ë ¥
                const messageInput = document.getElementById('messageInput');
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                messageInput.addEventListener('input', () => this.handleInputChange());

                document.getElementById('sendButton').addEventListener('click', () => this.sendMessage());

                // ë³´ì•ˆ ëª¨ë“œ ë³€ê²½
                document.querySelectorAll('.security-mode').forEach(btn => {
                    btn.addEventListener('click', () => this.setSecurityMode(btn.dataset.mode));
                });

                // UI ë²„íŠ¼ë“¤
                document.getElementById('usersButton').addEventListener('click', () => this.toggleUsersDropdown());
                document.getElementById('themeButton').addEventListener('click', () => this.toggleTheme());
                document.getElementById('logoutButton').addEventListener('click', () => this.logout());
                document.getElementById('mobileMenuButton')?.addEventListener('click', () => this.toggleSidebar());

                // PWA ì„¤ì¹˜
                document.getElementById('installButton')?.addEventListener('click', () => this.installPWA());
                document.getElementById('dismissInstall')?.addEventListener('click', () => this.hideInstallPrompt());

                // ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.chat-actions') && !e.target.closest('.users-dropdown')) {
                        this.hideUsersDropdown();
                    }
                });

                // í„°ì¹˜ ì œìŠ¤ì²˜ (ëª¨ë°”ì¼)
                this.setupTouchGestures();

                // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
                this.setupKeyboardShortcuts();

                // ë°© ìƒì„± ê´€ë ¨
                document.getElementById('createRoomButton').addEventListener('click', () => this.showCreateRoomModal());
                document.getElementById('cancelCreateRoom').addEventListener('click', () => this.hideCreateRoomModal());
                document.getElementById('createRoomForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createRoom();
                });
                document.getElementById('roomTypeSelect').addEventListener('change', () => this.togglePasswordField());

                // ë¹„ë°€ë°© ì…ì¥ ê´€ë ¨
                document.getElementById('cancelJoinSecret').addEventListener('click', () => this.hideJoinSecretModal());
                document.getElementById('joinSecretRoomForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.joinSecretRoom();
                });
            }

            setupTouchGestures() {
                let startX = 0;
                let startY = 0;

                document.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    if (!startX || !startY) return;

                    const diffX = e.touches[0].clientX - startX;
                    const diffY = e.touches[0].clientY - startY;

                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        // ìˆ˜í‰ ìŠ¤ì™€ì´í”„
                        if (diffX > 50 && startX < 50) {
                            // ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ - ì‚¬ì´ë“œë°” ì—´ê¸°
                            this.openSidebar();
                        } else if (diffX < -50 && startX > window.innerWidth - 50) {
                            // ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ - ì‚¬ì´ë“œë°” ë‹«ê¸°
                            this.closeSidebar();
                        }
                    }

                    startX = 0;
                    startY = 0;
                }, { passive: true });
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + Enter: ë©”ì‹œì§€ ì „ì†¡
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        this.sendMessage();
                    }
                    
                    // Ctrl/Cmd + D: ë‹¤í¬ëª¨ë“œ í† ê¸€
                    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                        e.preventDefault();
                        this.toggleTheme();
                    }

                    // Escape: ëª¨ë‹¬ ë‹«ê¸°
                    if (e.key === 'Escape') {
                        this.hideUsersDropdown();
                    }
                });
            }

            async guestLogin() {
                const nickname = document.getElementById('nicknameInput').value.trim();

                if (!nickname) {
                    this.showNotification('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (nickname.length > 20) {
                    this.showNotification('ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }

                const guestButton = document.getElementById('guestLoginButton');
                const originalText = guestButton.textContent;
                guestButton.textContent = 'ì—°ê²° ì¤‘...';
                guestButton.disabled = true;

                try {
                    const response = await fetch('/api/auth/guest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nickname })
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        this.currentUser = nickname;
                        this.userType = 'guest';
                        this.hideLoginModal();
                        this.connectWebSocket();
                        this.showNotification('ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                        this.updateUserInfo();
                    } else {
                        this.showNotification(result.error || 'ì…ì¥ ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    this.showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                } finally {
                    guestButton.textContent = originalText;
                    guestButton.disabled = false;
                }
            }

            async login() {
                const username = document.getElementById('usernameInput').value.trim();
                const password = document.getElementById('passwordInput').value;

                if (!username || !password) {
                    this.showNotification('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                const loginButton = document.getElementById('loginButton');
                const originalText = loginButton.textContent;
                loginButton.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                loginButton.disabled = true;

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        this.currentUser = username;
                        this.userType = 'member';
                        this.hideLoginModal();
                        this.connectWebSocket();
                        this.showNotification('ë¡œê·¸ì¸ ì„±ê³µ! ğŸ‰', 'success');
                        this.updateUserInfo();
                    } else {
                        this.showNotification(result.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    this.showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                } finally {
                    loginButton.textContent = originalText;
                    loginButton.disabled = false;
                }
            }

            async register() {
                const username = document.getElementById('regUsernameInput').value.trim();
                const email = document.getElementById('regEmailInput').value.trim();
                const password = document.getElementById('regPasswordInput').value;
                const passwordConfirm = document.getElementById('regPasswordConfirmInput').value;

                if (!username || !password) {
                    this.showNotification('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (password.length < 4) {
                    this.showNotification('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                    return;
                }

                if (password !== passwordConfirm) {
                    this.showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦ (ì…ë ¥ëœ ê²½ìš°ì—ë§Œ)
                if (email && !this.validateEmail(email)) {
                    this.showNotification('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
                    return;
                }

                const registerButton = document.getElementById('registerSubmitButton');
                const originalText = registerButton.textContent;
                registerButton.textContent = 'ê°€ì… ì¤‘...';
                registerButton.disabled = true;

                try {
                    const requestBody = { username, password };
                    if (email) {
                        requestBody.email = email;
                    }

                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        this.showNotification('íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš” âœ¨', 'success');
                        this.showLoginModal();
                        // íšŒì›ê°€ì… ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í¼ì— ì‚¬ìš©ìëª… ìë™ ì…ë ¥
                        document.getElementById('usernameInput').value = username;
                        document.getElementById('passwordInput').focus();
                    } else {
                        this.showNotification(result.error || 'íšŒì›ê°€ì… ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    this.showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                } finally {
                    registerButton.textContent = originalText;
                    registerButton.disabled = false;
                }
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/chat`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket ì—°ê²°ë¨');
                    this.updateConnectionStatus('connected');
                    // ì—°ê²° í›„ ìë™ìœ¼ë¡œ ì¼ë°˜ ì±„íŒ…ë°©ì— ì…ì¥
                    setTimeout(() => {
                        this.joinRoom('general');
                    }, 500);
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = () => {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œë¨');
                    this.updateConnectionStatus('disconnected');
                    setTimeout(() => this.reconnect(), 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                    this.updateConnectionStatus('error');
                };
            }

            reconnect() {
                if (this.currentUser) {
                    this.updateConnectionStatus('connecting');
                    this.connectWebSocket();
                }
            }

            handleMessage(message) {
                console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', message);
                switch (message.type) {
                    case 'roomlist':
                        this.updateRoomsList(JSON.parse(message.content));
                        break;
                    case 'userlist':
                        this.updateUsersList(JSON.parse(message.content));
                        break;
                    case 'system':
                        this.addSystemMessage(message.content);
                        break;
                    case 'message':
                    case 'file':
                    case 'volatile':
                        this.addMessage(message);
                        break;
                    case 'success':
                        // ë°© ìƒì„± ì„±ê³µ ì‹œ ì²˜ë¦¬
                        if (message.content && message.content.includes('ì„±ê³µì ìœ¼ë¡œ ìƒì„±')) {
                            // í˜„ì¬ ë°©ì„ ì†Œìœ í•œ ë°©ìœ¼ë¡œ ì¶”ê°€
                            if (this.currentRoom) {
                                this.ownedRooms.add(this.currentRoom);
                                console.log('ë°©ì¥ìœ¼ë¡œ ë“±ë¡ë¨:', this.currentRoom);
                                
                                // ì„ì‹œ ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‹¤ì œ ë°© IDì™€ ì—°ê²°
                                if (this.tempPassword) {
                                    this.roomPasswords.set(this.currentRoom, this.tempPassword);
                                    console.log('ë¹„ë°€ë²ˆí˜¸ ì €ì¥ë¨:', this.currentRoom);
                                    this.tempPassword = null;
                                }
                            }
                        }
                        this.addSystemMessage(message.content);
                        break;
                    case 'error':
                        this.showNotification(message.content, 'error');
                        break;
                    default:
                        console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', message.type);
                }
            }

            updateRoomsList(rooms) {
                const roomsList = document.getElementById('roomsList');
                roomsList.innerHTML = '';

                // í˜„ì¬ ë³´ì•ˆ ëª¨ë“œì— ë”°ë¼ ì±„íŒ…ë°© í•„í„°ë§
                const filteredRooms = this.filterRoomsBySecurityMode(rooms);

                filteredRooms.forEach(room => {
                    this.rooms.set(room.roomId, room);
                    
                    // ë°©ì¥ ì •ë³´ ì—…ë°ì´íŠ¸
                    if (room.creator === this.currentUser) {
                        this.ownedRooms.add(room.roomId);
                    }
                    
                    const roomElement = this.createRoomElement(room);
                    roomsList.appendChild(roomElement);
                });
            }

            filterRoomsBySecurityMode(rooms) {
                const currentMode = this.currentSecurityMode.toLowerCase();
                
                return rooms.filter(room => {
                    // ìƒˆë¡œìš´ ë°© íƒ€ì… ì •ë³´ ì‚¬ìš©
                    let roomType = 'normal';
                    if (room.roomType) {
                        roomType = room.roomType.toLowerCase();
                    } else {
                        // ê¸°ì¡´ ë°©ë“¤ì„ ìœ„í•œ í´ë°±
                        roomType = this.getRoomType(room.roomId);
                    }
                    
                    switch (currentMode) {
                        case 'normal':
                            return roomType === 'normal';
                        case 'secret':
                            return roomType === 'secret';
                        case 'volatile':
                            return roomType === 'volatile';
                        default:
                            return roomType === 'normal';
                    }
                });
            }

            createRoomElement(room) {
                const div = document.createElement('div');
                div.className = 'room-item';
                div.dataset.roomId = room.roomId;
                
                const roomType = this.getRoomType(room.roomId);
                const icon = this.getRoomIcon(roomType);
                
                div.innerHTML = `
                    <div class="room-icon ${roomType}">${icon}</div>
                    <div class="room-details">
                        <h4>${this.escapeHtml(room.roomName)}</h4>
                        <div class="room-meta">
                            <span>ğŸ‘¥ ${room.userCount || 0}ëª…</span>
                            <span>â€¢</span>
                            <span>${this.getSecurityModeText(roomType)}</span>
                        </div>
                    </div>
                `;

                div.addEventListener('click', () => {
                    const roomType = this.getRoomType(room.roomId);
                    if (roomType === 'secret' && !this.isRoomOwner(room.roomId)) {
                        this.showJoinSecretModal(room.roomId, room.roomName);
                    } else {
                        this.joinRoom(room.roomId);
                    }
                });
                return div;
            }

            getRoomType(roomId) {
                const room = this.rooms.get(roomId);
                if (room && room.roomType) {
                    return room.roomType.toLowerCase();
                }
                
                // ê¸°ë³¸ ë°©ë“¤ì„ ìœ„í•œ í´ë°±
                if (roomId === 'secret') return 'secret';
                if (roomId === 'volatile') return 'volatile';
                return 'normal';
            }

            getRoomIcon(type) {
                switch (type) {
                    case 'secret': return 'ğŸ”';
                    case 'volatile': return 'â°';
                    default: return 'ğŸ’¬';
                }
            }

            joinRoom(roomId) {
                if (this.currentRoom === roomId) return;

                // ê¸°ì¡´ ë°© ì„ íƒ í•´ì œ
                document.querySelectorAll('.room-item').forEach(item => {
                    item.classList.remove('active');
                });

                // ìƒˆ ë°© ì„ íƒ
                const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                if (roomElement) {
                    roomElement.classList.add('active');
                }

                this.currentRoom = roomId;
                this.updateChatHeader(roomId);
                this.clearMessages();
                this.closeSidebar(); // ëª¨ë°”ì¼ì—ì„œ ë°© ì„ íƒ í›„ ì‚¬ì´ë“œë°” ë‹«ê¸°

                // ì„œë²„ì— ë°© ì…ì¥ ìš”ì²­
                this.sendWebSocketMessage({
                    type: 'joinRoom',
                    roomId: roomId,
                    sender: this.currentUser
                });

                // íœ˜ë°œì„± ëª¨ë“œ UI ì—…ë°ì´íŠ¸
                const roomType = this.getRoomType(roomId);
                const volatileControls = document.getElementById('volatileControls');
                if (roomType === 'volatile') {
                    volatileControls.classList.add('show');
                } else {
                    volatileControls.classList.remove('show');
                }
            }

            updateChatHeader(roomId) {
                const room = this.rooms.get(roomId);
                if (!room) return;

                const roomType = this.getRoomType(roomId);
                const icon = this.getRoomIcon(roomType);

                const chatAvatar = document.getElementById('chatAvatar');
                const chatTitle = document.getElementById('chatTitle');
                const chatSecurityBadge = document.getElementById('chatSecurityBadge');
                const roomOwnerInfo = document.getElementById('roomOwnerInfo');
                const roomPassword = document.getElementById('roomPassword');

                chatAvatar.textContent = icon;
                chatAvatar.className = `chat-avatar ${roomType}`;
                chatTitle.textContent = room.roomName;
                
                chatSecurityBadge.className = `chat-security-badge ${roomType}`;
                chatSecurityBadge.textContent = this.getSecurityModeText(roomType);

                // ë°©ì¥ ì •ë³´ í‘œì‹œ
                if (this.isRoomOwner(roomId)) {
                    roomOwnerInfo.style.display = 'flex';
                    
                    // ë¹„ë°€ë°©ì¸ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ
                    if (roomType === 'secret') {
                        const password = this.roomPasswords.get(roomId);
                        if (password) {
                            roomPassword.textContent = `ğŸ”‘ ${password}`;
                            roomPassword.style.display = 'inline-block';
                        } else {
                            roomPassword.style.display = 'none';
                        }
                    } else {
                        roomPassword.style.display = 'none';
                    }
                } else {
                    roomOwnerInfo.style.display = 'none';
                }
            }

            getSecurityModeText(type) {
                switch (type) {
                    case 'secret': return 'ğŸ” ë¹„ë°€ ëŒ€í™”';
                    case 'volatile': return 'â° ì„ì‹œ ë©”ì‹œì§€';
                    default: return 'ì¼ë°˜ ëª¨ë“œ';
                }
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();
                
                if (!content || !this.currentRoom) {
                    console.log('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ë‚´ìš© ì—†ìŒ ë˜ëŠ” ë°© ì—†ìŒ', { content, currentRoom: this.currentRoom });
                    return;
                }

                const message = {
                    type: 'message',
                    sender: this.currentUser,
                    content: content,
                    roomId: this.currentRoom,
                    securityType: this.currentSecurityMode
                };

                // íœ˜ë°œì„± ë©”ì‹œì§€ì¸ ê²½ìš° íƒ€ì´ë¨¸ ì„¤ì •
                if (this.getRoomType(this.currentRoom) === 'volatile') {
                    const timer = document.getElementById('volatileTimer').value;
                    message.volatileDuration = parseInt(timer);
                }

                console.log('ë©”ì‹œì§€ ì „ì†¡:', message);
                this.sendWebSocketMessage(message);
                input.value = '';
                this.handleInputChange();
                
                // ì „ì†¡ ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
                const sendButton = document.getElementById('sendButton');
                sendButton.style.transform = 'scale(0.9) rotate(45deg)';
                setTimeout(() => {
                    sendButton.style.transform = '';
                }, 150);
            }

            addMessage(message) {
                const container = document.getElementById('messagesContainer');
                const messageElement = this.createMessageElement(message);
                container.appendChild(messageElement);
                
                // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });

                // íœ˜ë°œì„± ë©”ì‹œì§€ íƒ€ì´ë¨¸ ì‹œì‘
                if (message.type === 'volatile' && message.volatileDuration) {
                    this.startVolatileTimer(messageElement, message.volatileDuration);
                }

                // ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ (ë¸Œë¼ìš°ì €ê°€ ë°±ê·¸ë¼ìš´ë“œì¼ ë•Œ)
                if (document.hidden && message.sender !== this.currentUser) {
                    this.showDesktopNotification(message);
                }
            }

            createMessageElement(message) {
                const div = document.createElement('div');
                const isOwn = message.sender === this.currentUser;
                const isSystem = message.type === 'system';
                
                let classes = ['message'];
                if (isOwn) classes.push('own');
                if (isSystem) classes.push('system');
                if (message.securityType) classes.push(message.securityType.toLowerCase());
                
                div.className = classes.join(' ');

                if (isSystem) {
                    div.innerHTML = `
                        <div class="message-bubble">${this.escapeHtml(message.content)}</div>
                    `;
                } else {
                    const avatar = this.escapeHtml(message.sender.charAt(0).toUpperCase());
                    const sender = this.escapeHtml(message.sender);
                    const content = this.escapeHtml(message.content);
                    const timestamp = this.escapeHtml(message.timestamp);
                    const securityBadge = this.getSecurityBadge(message.securityType);
                    const volatileTimer = message.type === 'volatile' ?
                        `<div class="volatile-timer">${message.volatileDuration || 'â±'}</div>` : '';

                    div.innerHTML = `
                        <div class="message-avatar">${avatar}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${sender}</span>
                                <span class="message-time">${timestamp}</span>
                                ${securityBadge}
                            </div>
                            <div class="message-bubble">
                                ${content}
                                ${volatileTimer}
                            </div>
                        </div>
                    `;
                }

                return div;
            }

            getSecurityBadge(securityType) {
                if (!securityType || securityType === 'NORMAL') return '';
                
                const type = securityType.toLowerCase();
                const text = type === 'secret' ? 'ğŸ”' : 'ğŸ’¥';
                return `<span class="message-security-badge ${type}">${text}</span>`;
            }

            startVolatileTimer(messageElement, duration) {
                const timer = messageElement.querySelector('.volatile-timer');
                if (!timer) return;

                let remaining = duration;
                const interval = setInterval(() => {
                    remaining--;
                    timer.textContent = remaining;
                    
                    if (remaining <= 0) {
                        clearInterval(interval);
                        messageElement.style.opacity = '0';
                        messageElement.style.transform = 'scale(0.8) translateY(-10px)';
                        setTimeout(() => {
                            if (messageElement.parentNode) {
                                messageElement.remove();
                            }
                        }, 300);
                    } else if (remaining <= 5) {
                        // ë§ˆì§€ë§‰ 5ì´ˆ ë™ì•ˆ ê¹œë¹¡ì„ íš¨ê³¼
                        timer.style.animation = 'timerPulse 0.5s infinite';
                    }
                }, 1000);
            }

            addSystemMessage(content) {
                this.addMessage({
                    type: 'system',
                    content: content,
                    timestamp: new Date().toLocaleTimeString('ko-KR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                });
            }

            clearMessages() {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
            }

            setSecurityMode(mode) {
                this.currentSecurityMode = mode.toUpperCase();
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.security-mode').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (í•„í„°ë§ ì ìš©)
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.requestRoomList();
                }
                
                // ë³´ì•ˆ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ìë™ ì´ë™
                const targetRoom = this.getTargetRoomForMode(mode);
                if (targetRoom && targetRoom !== this.currentRoom) {
                    this.joinRoom(targetRoom);
                }
            }

            requestRoomList() {
                // ì„œë²„ì—ì„œ ë°© ëª©ë¡ì„ ë‹¤ì‹œ ìš”ì²­í•˜ì—¬ í•„í„°ë§ëœ ëª©ë¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                const rooms = Array.from(this.rooms.values());
                this.updateRoomsList(rooms);
            }

            getTargetRoomForMode(mode) {
                switch (mode) {
                    case 'normal': return 'general';
                    case 'secret': return 'secret';
                    case 'volatile': return 'volatile';
                    default: return 'general';
                }
            }

            isRoomOwner(roomId) {
                return this.ownedRooms.has(roomId);
            }

            updateUsersList(users) {
                const dropdown = document.getElementById('usersDropdown');
                dropdown.innerHTML = '';

                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `
                        <div class="online-indicator"></div>
                        <span>${user.username}</span>
                    `;
                    dropdown.appendChild(div);
                });
            }

            toggleUsersDropdown() {
                const dropdown = document.getElementById('usersDropdown');
                dropdown.classList.toggle('show');
            }

            hideUsersDropdown() {
                const dropdown = document.getElementById('usersDropdown');
                dropdown.classList.remove('show');
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                document.documentElement.setAttribute('data-theme', this.isDarkMode ? 'dark' : 'light');
                
                const themeButton = document.getElementById('themeButton');
                themeButton.textContent = this.isDarkMode ? 'â˜€ï¸ ë¼ì´íŠ¸' : 'ğŸŒ™ ë‹¤í¬';
                
                // í…Œë§ˆ ì„¤ì • ì €ì¥
                localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    this.isDarkMode = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                    const themeButton = document.getElementById('themeButton');
                    if (themeButton) themeButton.textContent = 'â˜€ï¸ ë¼ì´íŠ¸';
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('open');
            }

            openSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('open');
            }

            closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('open');
            }

            updateConnectionStatus(status) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = `status-dot ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusText.textContent = 'ì˜¨ë¼ì¸';
                        statusDot.style.background = 'var(--success)';
                        break;
                    case 'connecting':
                        statusText.textContent = 'ì—°ê²° ì¤‘...';
                        statusDot.style.background = 'var(--warning)';
                        break;
                    case 'disconnected':
                    case 'error':
                        statusText.textContent = 'ì˜¤í”„ë¼ì¸';
                        statusDot.style.background = 'var(--error)';
                        break;
                }
            }

            updateUserInfo() {
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                userName.textContent = this.currentUser;
                userAvatar.textContent = this.currentUser.charAt(0).toUpperCase();
            }

            handleInputChange() {
                const input = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                
                // ìë™ ë†’ì´ ì¡°ì ˆ
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                
                // ì „ì†¡ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                const hasContent = input.value.trim().length > 0;
                sendButton.disabled = !hasContent || !this.currentRoom;
            }

            sendWebSocketMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }

            showLoginModal() {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('registerModal').style.display = 'none';
                this.showGuestLoginForm();
                // ì €ì¥ëœ í…Œë§ˆ ë¡œë“œ
                this.loadTheme();
            }

            showGuestLoginForm() {
                document.getElementById('guestForm').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                // í¼ ì´ˆê¸°í™”
                document.getElementById('guestForm').reset();
            }

            showMemberLoginForm() {
                document.getElementById('guestForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                // í¼ ì´ˆê¸°í™”
                document.getElementById('loginForm').reset();
            }

            hideLoginModal() {
                document.getElementById('loginModal').style.display = 'none';
            }

            showRegisterModal() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('registerModal').style.display = 'flex';
                // í¼ ì´ˆê¸°í™”
                document.getElementById('registerForm').reset();
                document.getElementById('passwordMatchMessage').style.display = 'none';
            }

            checkPasswordMatch() {
                const password = document.getElementById('regPasswordInput').value;
                const passwordConfirm = document.getElementById('regPasswordConfirmInput').value;
                const message = document.getElementById('passwordMatchMessage');

                if (password && passwordConfirm) {
                    if (password === passwordConfirm) {
                        message.textContent = 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤';
                        message.style.color = 'var(--success)';
                        message.style.display = 'block';
                    } else {
                        message.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                        message.style.color = 'var(--error)';
                        message.style.display = 'block';
                    }
                } else {
                    message.style.display = 'none';
                }
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%) scale(0.8)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            showDesktopNotification(message) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${message.sender}`, {
                        body: message.content,
                        icon: '/icon-192x192.png',
                        tag: 'securechat-message'
                    });
                }
            }

            showInstallPrompt() {
                const prompt = document.getElementById('installPrompt');
                if (prompt) prompt.classList.add('show');
            }

            hideInstallPrompt() {
                const prompt = document.getElementById('installPrompt');
                if (prompt) prompt.classList.remove('show');
            }

            async installPWA() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    console.log(`ì‚¬ìš©ì ì„ íƒ: ${outcome}`);
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                }
            }

            logout() {
                const confirmMessage = this.userType === 'guest' ? 'ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                if (confirm(confirmMessage)) {
                    if (this.ws) {
                        this.ws.close();
                    }
                    this.currentUser = '';
                    this.currentRoom = '';
                    this.userType = 'guest';
                    this.showLoginModal();
                    const message = this.userType === 'guest' ? 'ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤' : 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤';
                    this.showNotification(message, 'info');
                }
            }

            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            checkEmailFormat() {
                const email = document.getElementById('regEmailInput').value.trim();
                const message = document.getElementById('emailFormatMessage');

                if (email) {
                    if (this.validateEmail(email)) {
                        message.textContent = 'âœ… ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤';
                        message.style.color = 'var(--success)';
                        message.style.display = 'block';
                    } else {
                        message.textContent = 'âŒ ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤';
                        message.style.color = 'var(--error)';
                        message.style.display = 'block';
                    }
                } else {
                    message.style.display = 'none';
                }
            }

            // ë°© ìƒì„± ê´€ë ¨ ë©”ì„œë“œë“¤
            showCreateRoomModal() {
                document.getElementById('createRoomModal').style.display = 'flex';
                document.getElementById('createRoomForm').reset();
                this.togglePasswordField();
            }

            hideCreateRoomModal() {
                document.getElementById('createRoomModal').style.display = 'none';
            }

            togglePasswordField() {
                const roomType = document.getElementById('roomTypeSelect').value;
                const passwordGroup = document.getElementById('passwordGroup');
                const passwordInput = document.getElementById('roomPasswordInput');
                
                if (roomType === 'SECRET') {
                    passwordGroup.style.display = 'block';
                    passwordInput.required = true;
                } else {
                    passwordGroup.style.display = 'none';
                    passwordInput.required = false;
                    passwordInput.value = '';
                }
            }

            async createRoom() {
                const roomName = document.getElementById('roomNameInput').value.trim();
                const roomType = document.getElementById('roomTypeSelect').value;
                const roomPassword = document.getElementById('roomPasswordInput').value;
                const roomDesc = document.getElementById('roomDescInput').value.trim();

                if (!roomName) {
                    this.showNotification('ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (roomType === 'SECRET' && !roomPassword) {
                    this.showNotification('ë¹„ë°€ë°©ì€ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                    return;
                }

                const createButton = document.getElementById('submitCreateRoom');
                const originalText = createButton.textContent;
                createButton.textContent = 'ìƒì„± ì¤‘...';
                createButton.disabled = true;

                try {
                    const roomData = {
                        roomName: roomName,
                        roomType: roomType,
                        creator: this.currentUser,
                        description: roomDesc || null
                    };

                    if (roomType === 'SECRET') {
                        roomData.password = roomPassword;
                    }

                    // WebSocketì„ í†µí•´ ë°© ìƒì„± ìš”ì²­
                    this.sendWebSocketMessage({
                        type: 'createRoom',
                        ...roomData
                    });

                    // ë¹„ë°€ë°©ì¸ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ì €ì¥
                    if (roomType === 'SECRET') {
                        // ì„ì‹œë¡œ ì €ì¥ (ë°© ìƒì„± ì„±ê³µ ì‹œ ì‹¤ì œ ë°© IDì™€ ì—°ê²°ë¨)
                        this.tempPassword = roomPassword;
                    }

                    this.hideCreateRoomModal();
                    this.showNotification('ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                    
                } catch (error) {
                    this.showNotification('ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                } finally {
                    createButton.textContent = originalText;
                    createButton.disabled = false;
                }
            }

            // ë¹„ë°€ë°© ì…ì¥ ê´€ë ¨ ë©”ì„œë“œë“¤
            showJoinSecretModal(roomId, roomName) {
                this.pendingSecretRoomId = roomId;
                document.getElementById('secretRoomName').textContent = `${roomName} ì…ì¥`;
                document.getElementById('joinSecretRoomModal').style.display = 'flex';
                document.getElementById('joinSecretRoomForm').reset();
            }

            hideJoinSecretModal() {
                document.getElementById('joinSecretRoomModal').style.display = 'none';
                this.pendingSecretRoomId = null;
            }

            joinSecretRoom() {
                const password = document.getElementById('secretRoomPasswordInput').value;
                
                if (!password) {
                    this.showNotification('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (this.pendingSecretRoomId) {
                    this.sendWebSocketMessage({
                        type: 'joinSecretRoom',
                        roomId: this.pendingSecretRoomId,
                        password: password,
                        sender: this.currentUser
                    });
                    
                    this.hideJoinSecretModal();
                }
            }
        }

        // ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new BEAMApp();
        });

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ì—°ê²° ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (window.chatApp && window.chatApp.ws) {
                window.chatApp.ws.close();
            }
        });

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && window.chatApp) {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ í™œì„±í™”ë  ë•Œ ì—°ê²° ìƒíƒœ í™•ì¸
                if (window.chatApp.ws && window.chatApp.ws.readyState !== WebSocket.OPEN) {
                    window.chatApp.reconnect();
                }
            }
        });
    </script>
</body>
</html>