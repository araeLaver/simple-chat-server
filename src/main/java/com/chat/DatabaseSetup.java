package com.chat;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;
import java.sql.SQLException;
import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;

public class DatabaseSetup {
    
    private static final String DB_URL = "jdbc:postgresql://ep-blue-unit-a2ev3s9x.eu-central-1.pg.koyeb.app/koyebdb?sslmode=require";
    private static final String USERNAME = "koyeb-adm";
    private static final String PASSWORD = "TRQuyavq9W5B";
    
    public static void main(String[] args) {
        System.out.println("üöÄ PostgreSQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏãúÏûë...");
        
        try {
            // ÎìúÎùºÏù¥Î≤Ñ Î°úÎìú
            Class.forName("org.postgresql.Driver");
            
            // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞
            Connection connection = DriverManager.getConnection(DB_URL, USERNAME, PASSWORD);
            Statement statement = connection.createStatement();
            
            // 1. Ïä§ÌÇ§Îßà ÏÉùÏÑ±
            System.out.println("üìÅ Ïä§ÌÇ§Îßà ÏÉùÏÑ± Ï§ë...");
            statement.execute("CREATE SCHEMA IF NOT EXISTS chatapp_dev");
            statement.execute("CREATE SCHEMA IF NOT EXISTS chatapp_prod");
            System.out.println("‚úÖ Ïä§ÌÇ§Îßà ÏÉùÏÑ± ÏôÑÎ£å");
            
            // 2. chatapp_dev Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî
            System.out.println("üîß chatapp_dev Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî Ï§ë...");
            setupDevSchema(statement);
            System.out.println("‚úÖ chatapp_dev Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
            
            // 3. chatapp_prod Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî
            System.out.println("üîß chatapp_prod Ïä§ÌÇ§Îßà Ï¥àÍ∏∞Ìôî Ï§ë...");
            setupProdSchema(statement);
            System.out.println("‚úÖ chatapp_prod Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
            
            // 4. ÌÖåÏù¥Î∏î ÌôïÏù∏
            System.out.println("üîç ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÌôïÏù∏ Ï§ë...");
            verifyTables(statement);
            
            statement.close();
            connection.close();
            System.out.println("üéâ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!");
            
        } catch (Exception e) {
            System.err.println("‚ùå Ïò§Î•ò Î∞úÏÉù: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private static void setupDevSchema(Statement statement) throws SQLException {
        statement.execute("SET search_path TO chatapp_dev");
        
        // Í∏∞Ï°¥ ÌÖåÏù¥Î∏î ÏÇ≠Ï†ú
        statement.execute("DROP TABLE IF EXISTS user_sessions CASCADE");
        statement.execute("DROP TABLE IF EXISTS messages CASCADE");
        statement.execute("DROP TABLE IF EXISTS chat_rooms CASCADE");
        statement.execute("DROP TABLE IF EXISTS users CASCADE");
        statement.execute("DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE");
        
        // ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        createTables(statement);
        createInitialData(statement);
    }
    
    private static void setupProdSchema(Statement statement) throws SQLException {
        statement.execute("SET search_path TO chatapp_prod");
        
        // Í∏∞Ï°¥ ÌÖåÏù¥Î∏î ÏÇ≠Ï†ú
        statement.execute("DROP TABLE IF EXISTS user_sessions CASCADE");
        statement.execute("DROP TABLE IF EXISTS messages CASCADE");
        statement.execute("DROP TABLE IF EXISTS chat_rooms CASCADE");
        statement.execute("DROP TABLE IF EXISTS users CASCADE");
        statement.execute("DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE");
        
        // ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        createTables(statement);
        createInitialData(statement);
    }
    
    private static void createTables(Statement statement) throws SQLException {
        // Users Table
        statement.execute("""
            CREATE TABLE users (
                id BIGSERIAL PRIMARY KEY,
                username VARCHAR(50) NOT NULL UNIQUE,
                password VARCHAR(255) NOT NULL,
                email VARCHAR(255),
                last_login TIMESTAMP,
                is_active BOOLEAN NOT NULL DEFAULT true,
                profile_image VARCHAR(500),
                status_message VARCHAR(200),
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """);
        
        // Chat Rooms Table
        statement.execute("""
            CREATE TABLE chat_rooms (
                room_id VARCHAR(50) PRIMARY KEY,
                room_name VARCHAR(100) NOT NULL,
                room_type VARCHAR(20) NOT NULL DEFAULT 'NORMAL',
                encryption_key VARCHAR(255),
                description VARCHAR(500),
                is_active BOOLEAN NOT NULL DEFAULT true,
                max_users INTEGER,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT chk_room_type CHECK (room_type IN ('NORMAL', 'SECRET', 'VOLATILE'))
            )
        """);
        
        // Messages Table
        statement.execute("""
            CREATE TABLE messages (
                id BIGSERIAL PRIMARY KEY,
                user_id BIGINT,
                sender VARCHAR(50) NOT NULL,
                content TEXT,
                room_id VARCHAR(50) NOT NULL,
                message_type VARCHAR(20) NOT NULL,
                timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                security_type VARCHAR(20) NOT NULL DEFAULT 'NORMAL',
                expires_at TIMESTAMP,
                encryption_key VARCHAR(255),
                is_encrypted BOOLEAN NOT NULL DEFAULT false,
                file_url VARCHAR(500),
                file_name VARCHAR(255),
                file_size BIGINT,
                edited_at TIMESTAMP,
                is_deleted BOOLEAN NOT NULL DEFAULT false,
                CONSTRAINT chk_security_type CHECK (security_type IN ('NORMAL', 'SECRET', 'VOLATILE')),
                CONSTRAINT chk_message_type CHECK (message_type IN ('message', 'system', 'file', 'volatile')),
                CONSTRAINT fk_messages_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
                CONSTRAINT fk_messages_room_id FOREIGN KEY (room_id) REFERENCES chat_rooms(room_id) ON DELETE CASCADE
            )
        """);
        
        // User Sessions Table
        statement.execute("""
            CREATE TABLE user_sessions (
                id BIGSERIAL PRIMARY KEY,
                session_id VARCHAR(100) NOT NULL,
                user_id BIGINT NOT NULL,
                username VARCHAR(50) NOT NULL,
                room_id VARCHAR(50),
                ip_address VARCHAR(45),
                user_agent VARCHAR(500),
                is_online BOOLEAN NOT NULL DEFAULT true,
                last_activity TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                connected_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                disconnected_at TIMESTAMP,
                CONSTRAINT fk_sessions_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                CONSTRAINT fk_sessions_room_id FOREIGN KEY (room_id) REFERENCES chat_rooms(room_id) ON DELETE SET NULL
            )
        """);
        
        // Ïù∏Îç±Ïä§ ÏÉùÏÑ±
        createIndexes(statement);
        
        // Ìä∏Î¶¨Í±∞ Ìï®Ïàò Î∞è Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±
        createTriggers(statement);
    }
    
    private static void createIndexes(Statement statement) throws SQLException {
        // Users Ïù∏Îç±Ïä§
        statement.execute("CREATE INDEX idx_users_username ON users(username)");
        statement.execute("CREATE INDEX idx_users_email ON users(email)");
        statement.execute("CREATE INDEX idx_users_is_active ON users(is_active)");
        statement.execute("CREATE INDEX idx_users_created_at ON users(created_at)");
        
        // Chat Rooms Ïù∏Îç±Ïä§
        statement.execute("CREATE INDEX idx_chat_rooms_room_type ON chat_rooms(room_type)");
        statement.execute("CREATE INDEX idx_chat_rooms_is_active ON chat_rooms(is_active)");
        
        // Messages Ïù∏Îç±Ïä§
        statement.execute("CREATE INDEX idx_messages_room_id ON messages(room_id)");
        statement.execute("CREATE INDEX idx_messages_sender ON messages(sender)");
        statement.execute("CREATE INDEX idx_messages_timestamp ON messages(timestamp)");
        statement.execute("CREATE INDEX idx_messages_user_id ON messages(user_id)");
        statement.execute("CREATE INDEX idx_messages_security_type ON messages(security_type)");
        statement.execute("CREATE INDEX idx_messages_expires_at ON messages(expires_at)");
        statement.execute("CREATE INDEX idx_messages_is_deleted ON messages(is_deleted)");
        
        // User Sessions Ïù∏Îç±Ïä§
        statement.execute("CREATE INDEX idx_sessions_session_id ON user_sessions(session_id)");
        statement.execute("CREATE INDEX idx_sessions_user_id ON user_sessions(user_id)");
        statement.execute("CREATE INDEX idx_sessions_room_id ON user_sessions(room_id)");
        statement.execute("CREATE INDEX idx_sessions_is_online ON user_sessions(is_online)");
        statement.execute("CREATE INDEX idx_sessions_last_activity ON user_sessions(last_activity)");
    }
    
    private static void createTriggers(Statement statement) throws SQLException {
        // Ìä∏Î¶¨Í±∞ Ìï®Ïàò ÏÉùÏÑ±
        statement.execute("""
            CREATE OR REPLACE FUNCTION update_updated_at_column()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END;
            $$ language 'plpgsql'
        """);
        
        // Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±
        statement.execute("""
            CREATE TRIGGER update_users_updated_at 
                BEFORE UPDATE ON users 
                FOR EACH ROW 
                EXECUTE FUNCTION update_updated_at_column()
        """);
        
        statement.execute("""
            CREATE TRIGGER update_chat_rooms_updated_at 
                BEFORE UPDATE ON chat_rooms 
                FOR EACH ROW 
                EXECUTE FUNCTION update_updated_at_column()
        """);
    }
    
    private static void createInitialData(Statement statement) throws SQLException {
        // Í∏∞Î≥∏ Ï±ÑÌåÖÎ∞© ÏÉùÏÑ±
        statement.execute("""
            INSERT INTO chat_rooms (room_id, room_name, room_type, description, max_users) VALUES
            ('general', 'ÏùºÎ∞ò Ï±ÑÌåÖÎ∞©', 'NORMAL', 'Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∞∏Ïó¨Ìï† Ïàò ÏûàÎäî ÏùºÎ∞ò Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.', NULL),
            ('tech', 'Í∞úÎ∞ú Ïù¥ÏïºÍ∏∞', 'NORMAL', 'Í∞úÎ∞úÍ≥º Í∏∞Ïà†Ïóê Í¥ÄÌïú Ïù¥ÏïºÍ∏∞Î•º ÎÇòÎàÑÎäî Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.', NULL),
            ('casual', 'ÏûêÏú† ÌÜ†Î°†', 'NORMAL', 'ÏûêÏú†Î°≠Í≤å ÎåÄÌôîÎ•º ÎÇòÎàÑÎäî Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.', NULL),
            ('secret', 'üîê ÎπÑÎ∞Ä ÎåÄÌôî', 'SECRET', 'ÏïîÌò∏ÌôîÎêú Î©îÏãúÏßÄÎ°ú ÏïàÏ†ÑÌïú ÎåÄÌôîÎ•º ÎÇòÎàÑÎäî Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.', 10),
            ('volatile', 'üí• ÌúòÎ∞úÏÑ± Ï±ÑÌåÖ', 'VOLATILE', 'Î©îÏãúÏßÄÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏÇ≠Ï†úÎêòÎäî ÌúòÎ∞úÏÑ± Ï±ÑÌåÖÎ∞©ÏûÖÎãàÎã§.', 20)
        """);
        
        // secret Î∞©Ïóê ÏïîÌò∏Ìôî ÌÇ§ ÏÑ§Ï†ï
        statement.execute("UPDATE chat_rooms SET encryption_key = 'secret123' WHERE room_id = 'secret'");
    }
    
    private static void verifyTables(Statement statement) throws SQLException {
        // dev Ïä§ÌÇ§Îßà ÌÖåÏù¥Î∏î ÌôïÏù∏
        System.out.println("\nüìä chatapp_dev Ïä§ÌÇ§Îßà ÌÖåÏù¥Î∏î:");
        var devResult = statement.executeQuery("""
            SELECT table_name FROM information_schema.tables 
            WHERE table_schema = 'chatapp_dev' 
            ORDER BY table_name
        """);
        while (devResult.next()) {
            System.out.println("  ‚úì " + devResult.getString("table_name"));
        }
        
        // prod Ïä§ÌÇ§Îßà ÌÖåÏù¥Î∏î ÌôïÏù∏
        System.out.println("\nüìä chatapp_prod Ïä§ÌÇ§Îßà ÌÖåÏù¥Î∏î:");
        var prodResult = statement.executeQuery("""
            SELECT table_name FROM information_schema.tables 
            WHERE table_schema = 'chatapp_prod' 
            ORDER BY table_name
        """);
        while (prodResult.next()) {
            System.out.println("  ‚úì " + prodResult.getString("table_name"));
        }
        
        // Ï±ÑÌåÖÎ∞© Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
        statement.execute("SET search_path TO chatapp_dev");
        var roomsResult = statement.executeQuery("SELECT room_id, room_name FROM chat_rooms ORDER BY room_id");
        System.out.println("\nüè† ÏÉùÏÑ±Îêú Ï±ÑÌåÖÎ∞©:");
        while (roomsResult.next()) {
            System.out.println("  üè† " + roomsResult.getString("room_id") + ": " + roomsResult.getString("room_name"));
        }
    }
}